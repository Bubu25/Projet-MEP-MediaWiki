---
# tasks file for mw.mediawiki
#Création directory, recup des tar et decompress
- name : directory appli
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /home/appli
    - /home/appli/MWA_mediawiki
    - /home/appli/MWA_mediawiki/LIVR
    - /home/appli/MWA_mediawiki/LIVR/01.00.00

- name: git repo
  get_url:
    url: "{{ item }}"
    dest: /tmp
  loop:
    - https://github.com/Bubu25/Projet-MEP-MediaWiki/raw/Lyndsey-develop/INPUT/PACKAGE/wikidevops.tar.gz
    - https://github.com/Bubu25/Projet-MEP-MediaWiki/raw/Lyndsey-develop/INPUT/PACKAGE/dump_image.tar.gz
    - https://github.com/Bubu25/Projet-MEP-MediaWiki/raw/Lyndsey-develop/INPUT/PACKAGE/LoGo.tar.gz
    - https://github.com/Bubu25/Projet-MEP-MediaWiki/raw/Lyndsey-develop/INPUT/PACKAGE/Relivraison_24052021.tar.gz

- name: untar package
  unarchive:
    src: "{{ item }}"
    dest: /home/appli/MWA_mediawiki/LIVR
    remote_src: yes
  loop:
    - /tmp/wikidevops.tar.gz
    - /tmp/dump_image.tar.gz
    - /tmp/LoGo.tar.gz
    - /tmp/Relivraison_24052021.tar.gz

- name: move Données
  copy:
    src: /home/appli/MWA_mediawiki/LIVR/LoGo/GRA-135.png
    dest: /home/appli/MWA_mediawiki/LIVR/wikidevops/resources/assets
    remote_src: yes

- name: chmod
  file:
    dest: /home/appli/MWA_mediawiki/LIVR/wikidevops
    owner: root
    group: www-data
    mode: 0775
    recurse: yes


- name: création du lien symbolique
  file:
    src: /home/appli/MWA_mediawiki/LIVR/wikidevops
    dest: /var/www/html/wikidevops
    state: link
  notify: restart apache2

- name: install par script
  command: "{{ item }}"
  loop:
    - "php install.php --dbname wikiLN --dbuser userwikiLN --dbpass az --dbserver localhost --server 'http://192.168.1.26' --dbtype mysql --wiki wikiLN --pass azerty123admin --lang fr --scriptpath /wikidevops --confpath /home/appli/MWA_mediawiki/LIVR/wikidevops wikiLN admin"
    - "php importDump.php --wiki wikiLN --server 'http://192.168.1.26' --dbuser userwikiLN --dbpass az /home/appli/MWA_mediawiki/LIVR/Donnees.xml"
    - "php rebuildrecentchanges.php"
    - "php initSiteStats.php"
    - "php importImages.php --wiki wikiLN --server 'http://192.168.1.26' --dbuser userwikiLN --dbpass az /home/appli/MWA_mediawiki/LIVR/images"
    - "php importImages.php --wiki wikiLN --server 'http://192.168.1.26' --dbuser userwikiLN --dbpass az /home/appli/MWA_mediawiki/LIVR/images/Devops.png"
  args:
    chdir: /home/appli/MWA_mediawiki/LIVR/wikidevops/maintenance

- name: sed
  shell: sed -i 's/wiki\.png/GRA-135\.png/' /home/appli/MWA_mediawiki/LIVR/wikidevops/LocalSettings.php
